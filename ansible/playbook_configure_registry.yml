---
- name: Configure Docker Insecure Registry
  hosts: all
  become: yes
  vars:
    gitlab_registry_host: "{{ hostvars[groups['gitlab'][0]]['ansible_host'] }}"
  tasks:
    - name: Check if Docker is installed
      command: which docker
      register: docker_check
      failed_when: false
      changed_when: false

    - name: Create /etc/docker directory if it doesn't exist
      file:
        path: /etc/docker
        state: directory
        mode: '0755'
      when: docker_check.rc == 0

    - name: Configure Docker daemon for insecure registry
      copy:
        content: |
          {
            "insecure-registries": ["gitlab.local:5050", "{{ gitlab_registry_host }}:5050", "localhost:5050"],
            "storage-driver": "overlay2"
          }
        dest: /etc/docker/daemon.json
        mode: '0644'
      when: docker_check.rc == 0
      register: docker_config

    - name: Restart Docker service
      systemd:
        name: docker
        daemon_reload: yes
        state: restarted
        enabled: yes
      when: 
        - docker_check.rc == 0
        - docker_config.changed

    - name: Restart GitLab Runner if present
      systemd:
        name: gitlab-runner
        state: restarted
      when: 
        - docker_check.rc == 0
        - docker_config.changed
      failed_when: false

    - name: Display configuration result
      debug:
        msg: "Docker configured for insecure registry: gitlab.local:5050, {{ gitlab_registry_host }}:5050"
      when: docker_check.rc == 0
