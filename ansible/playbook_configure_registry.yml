---
- name: Configuration du Registre Docker Non Sécurisé
  hosts: all
  become: yes
  tasks:
    - name: Vérification de l'installation de Docker
      command: which docker
      register: docker_check
      failed_when: false
      changed_when: false

    - name: Création du répertoire /etc/docker s'il n'existe pas
      file:
        path: /etc/docker
        state: directory
        mode: '0755'
      when: docker_check.rc == 0

    - name: Configuration du démon Docker pour registre non sécurisé
      copy:
        content: |
          {
            "insecure-registries": ["gitlab.local:5005", "10.129.5.71:5005"]
          }
        dest: /etc/docker/daemon.json
        mode: '0644'
      when: docker_check.rc == 0
      register: docker_config

    - name: Redémarrage du service Docker
      systemd:
        name: docker
        state: restarted
        enabled: yes
      when: 
        - docker_check.rc == 0
        - docker_config.changed

    - name: Redémarrage du Runner GitLab si présent
      systemd:
        name: gitlab-runner
        state: restarted
      when: 
        - docker_check.rc == 0
        - docker_config.changed
      failed_when: false

    - name: Affichage du résultat de la configuration
      debug:
        msg: "Docker configuré pour le registre non sécurisé : gitlab.local:5005, 10.129.5.71:5005"
      when: docker_check.rc == 0
