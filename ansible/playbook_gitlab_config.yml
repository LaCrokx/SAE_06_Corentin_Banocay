- name: Automate GitLab Configuration (Deploy Tokens & Variables)
  hosts: gitlab
  become: yes
  tasks:
    - name: Wait for GitLab to be ready
      command: gitlab-rails runner "puts 'GitLab is ready'"
      register: gitlab_ready
      until: gitlab_ready.rc == 0
      retries: 20
      delay: 15

    - name: Create Deploy Token and Variables via Rails Runner
      command: |
        gitlab-rails runner "
          project_path = 'root/python-microservice-tornado'
          project = Project.find_by_full_path(project_path)
          
          if project
            # 1. Create Deploy Token
            token_name = 'k8s-deploy-token'
            deploy_token = project.deploy_tokens.find_by(name: token_name)
            
            unless deploy_token
              deploy_token = project.deploy_tokens.create!(
                name: token_name,
                read_registry: true,
                username: 'k8s-deploy-token-user',
                expires_at: 1.year.from_now
              )
              puts 'Deploy Token created.'
            else
              puts 'Deploy Token already exists.'
            end

            # 2. Set CI/CD Variables
            def set_variable(project, key, value)
              variable = project.variables.find_or_initialize_by(key: key)
              variable.update!(value: value, masked: false, protected: false)
            end

            # Only update variables if we have the token (newly created or retrieved)
            if deploy_token
              set_variable(project, 'K8S_REGISTRY_USER', deploy_token.username)
              set_variable(project, 'K8S_REGISTRY_PASSWORD', deploy_token.token)
              puts 'CI/CD Variables updated.'
            end
          else
            puts 'Project not found: ' + project_path
            exit 1
          end
        "
      register: rails_output
      changed_when: "'Deploy Token created' in rails_output.stdout or 'CI/CD Variables updated' in rails_output.stdout"
      failed_when: "'Project not found' in rails_output.stdout or rails_output.rc != 0"

    - name: Display Rails Runner Output
      debug:
        msg: "{{ rails_output.stdout_lines }}"
