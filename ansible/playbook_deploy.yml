---
- name: Automatisering du déploiement Microservice
  hosts: gitlab
  gather_facts: no
  vars:
    gl_local_url: "http://127.0.0.1"
    app_identifier: "python-microservice-tornado"
    repo_path: "root/{{ app_identifier }}"
    temp_git_dir: "/tmp/{{ app_identifier }}"
    src_dir: "/tmp/microservice-source"
    admin_user: "root"
    
  tasks:
    - name: Transfert des sources vers l'instance GitLab
      synchronize:
        src: "{{ playbook_dir }}/../tutorial-python-microservice-tornado-master/"
        dest: "{{ src_dir }}/"
        recursive: yes
        delete: no
        rsync_opts:
          - "--exclude=.git"
          - "--exclude=.venv"
          - "--exclude=__pycache__"
          - "--exclude=*.pyc"

    - name: Vérification de la disponibilité du service Web GitLab
      uri:
        url: "{{ gl_local_url }}/"
        status_code: 200,302
        timeout: 10
        follow_redirects: none
      register: gl_service_check
      until: gl_service_check.status in [200, 302]
      retries: 30
      delay: 10

    - name: Extraction du mot de passe administrateur initial
      shell: grep 'Password:' /etc/gitlab/initial_root_password 2>/dev/null | awk '{print $2}' || grep Password /root/gitlab_credentials.txt 2>/dev/null | awk '{print $2}'
      register: admin_pass_raw
      changed_when: false
      failed_when: false

    - name: Enregistrement du mot de passe
      set_fact:
        gl_root_password: "{{ admin_pass_raw.stdout | trim }}"

    - name: Debug des identifiants (interne)
      debug:
        msg:
          - "Endpoint : {{ gl_local_url }}"
          - "Utilisateur : {{ admin_user }}"
          - "Pwd : {{ gl_root_password }}"

    - name: Génération du Token d'accès via Rails console
      shell: |
        gitlab-rails runner "
        u = User.find_by(username: 'root')
        t = u.personal_access_tokens.create(
          name: 'deploy-token',
          scopes: ['api', 'write_repository', 'read_repository'],
          expires_at: 365.days.from_now
        )
        puts t.token
        " 2>/dev/null | tail -1
      register: token_output
      changed_when: false
      failed_when: false

    - name: Stockage du Token API
      set_fact:
        api_access_token: "{{ token_output.stdout | trim }}"
      when: token_output.stdout is defined and token_output.stdout != ""

    - name: Audit existence du projet
      uri:
        url: "{{ gl_local_url }}/api/v4/projects/{{ repo_path | urlencode }}"
        method: GET
        headers:
          PRIVATE-TOKEN: "{{ api_access_token }}"
        status_code: [200, 404]
        validate_certs: no
      register: project_exists_check
      when: api_access_token is defined

    - name: Initialisation du dépôt GitLab via API
      uri:
        url: "{{ gl_local_url }}/api/v4/projects"
        method: POST
        headers:
          PRIVATE-TOKEN: "{{ api_access_token }}"
        body_format: json
        body:
          name: "{{ app_identifier }}"
          path: "{{ app_identifier }}"
          visibility: "public"
          initialize_with_readme: false
        status_code: [200, 201, 400]
        validate_certs: no
      register: create_project_resp
      when: 
        - api_access_token is defined
        - project_exists_check.status == 404
      failed_when: false

    - name: Récupération métadonnées du projet
      uri:
        url: "{{ gl_local_url }}/api/v4/projects/root%2F{{ app_identifier }}"
        method: GET
        headers:
          PRIVATE-TOKEN: "{{ api_access_token }}"
        status_code: [200, 404]
        validate_certs: no
      register: project_meta
      when: api_access_token is defined
      failed_when: false

    - name: Info Projet
      debug:
        msg:
          - "Projet URL : {{ gl_local_url }}/{{ repo_path }}"
          - "ID : {{ project_meta.json.id | default('1') }}"

    - name: Nettoyage espace de travail temporaire
      file:
        path: "{{ temp_git_dir }}"
        state: absent

    - name: Préparation espace de travail git
      file:
        path: "{{ temp_git_dir }}"
        state: directory
        mode: '0755'

    - name: Configuration git local
      shell: |
        cd {{ temp_git_dir }}
        git init
        git config user.name "DeployBot"
        git config user.email "deploy@local.host"
      args:
        executable: /bin/bash

    - name: Peuplement du dépôt
      command: cp -r "{{ src_dir }}/." "{{ temp_git_dir }}/"

    - name: Suppression artefacts python (.venv)
      file:
        path: "{{ temp_git_dir }}/.venv"
        state: absent

    - name: Suppression artefacts python (__pycache__)
      file:
        path: "{{ temp_git_dir }}/__pycache__"
        state: absent

    - name: Nettoyage fichiers compilés
      command: find "{{ temp_git_dir }}" -name '*.pyc' -delete

    - name: Vérification présence CI/CD manifest
      stat:
        path: "{{ temp_git_dir }}/.gitlab-ci.yml"
      register: ci_file_check

    - name: Statut CI/CD
      debug:
        msg: "{{ 'CI détecté' if ci_file_check.stat.exists else 'Pas de CI' }}"

    - name: Configuration Remote Git
      shell: |
        cd {{ temp_git_dir }}
        PASS_ENC=$(echo "{{ gl_root_password }}" | sed 's/+/%2B/g; s/\//%2F/g; s/=/%3D/g')
        git remote add origin "http://{{ admin_user }}:${PASS_ENC}@127.0.0.1/{{ repo_path }}.git" || true
      args:
        executable: /bin/bash
      when: gl_root_password != ""

    - name: Indexation des fichiers
      shell: |
        cd {{ temp_git_dir }}
        git add .
      args:
        executable: /bin/bash

    - name: Commit initial
      shell: |
        cd {{ temp_git_dir }}
        git commit -m "Init: Microservice Source Code" || true
      args:
        executable: /bin/bash

    - name: Renommage branche principale
      shell: |
        cd {{ temp_git_dir }}
        git branch -M main
      args:
        executable: /bin/bash

    - name: Suppression protection branche main
      uri:
        url: "{{ gl_local_url }}/api/v4/projects/{{ project_meta.json.id }}/protected_branches/main"
        method: DELETE
        headers:
          PRIVATE-TOKEN: "{{ api_access_token }}"
        status_code: [204, 404]
        validate_certs: no
      register: unprotect_branch
      when: 
        - api_access_token is defined
        - project_meta.json.id is defined
      failed_when: false

    - name: Push vers le dépôt
      shell: |
        cd {{ temp_git_dir }}
        git push -u origin main --force
      args:
        executable: /bin/bash
      register: git_push_log
      when: gl_root_password != ""

    - name: Log du push
      debug:
        var: git_push_log.stdout_lines
      when: git_push_log is defined

    - name: Injection Variable CI - User
      uri:
        url: "{{ gl_local_url }}/api/v4/projects/{{ project_meta.json.id }}/variables"
        method: POST
        headers:
          PRIVATE-TOKEN: "{{ api_access_token }}"
        body_format: json
        body:
          key: "K8S_REGISTRY_USER"
          value: "{{ admin_user }}"
          protected: false
          masked: false
        status_code: [201, 400]
        validate_certs: no
      when: 
        - api_access_token is defined
        - project_meta.json.id is defined
      failed_when: false

    - name: Injection Variable CI - Password
      uri:
        url: "{{ gl_local_url }}/api/v4/projects/{{ project_meta.json.id }}/variables"
        method: POST
        headers:
          PRIVATE-TOKEN: "{{ api_access_token }}"
        body_format: json
        body:
          key: "K8S_REGISTRY_PASSWORD"
          value: "{{ api_access_token }}"
          protected: false
          masked: true
        status_code: [201, 400]
        validate_certs: no
      when: 
        - api_access_token is defined
        - project_meta.json.id is defined
      failed_when: false

    - name: Déclenchement manuel du Pipeline
      uri:
        url: "{{ gl_local_url }}/api/v4/projects/{{ project_meta.json.id }}/pipeline"
        method: POST
        headers:
          PRIVATE-TOKEN: "{{ api_access_token }}"
        body_format: json
        body:
          ref: "main"
        status_code: [200, 201]
        validate_certs: no
      register: pipeline_trigger
      when: 
        - api_access_token is defined
        - ci_file_check.stat.exists
        - project_meta.json.id is defined
      failed_when: false

    - name: Enregistrement d'un Runner (API)
      uri:
        url: "{{ gl_local_url }}/api/v4/user/runners"
        method: POST
        headers:
          PRIVATE-TOKEN: "{{ api_access_token }}"
        body_format: json
        body:
          runner_type: "instance_type"
          description: "Runner Shell Auto-provisionné"
          tag_list: ["shell", "docker", "automated"]
          run_untagged: true
          locked: false
        status_code: [201, 400]
        validate_certs: no
      register: runner_created
      when: api_access_token is defined
      failed_when: false

    - name: Récupération Token Runner
      set_fact:
        runner_auth_token: "{{ runner_created.json.token }}"
      when: 
        - runner_created.json is defined
        - runner_created.json.token is defined

    - name: Configuration locale du Runner
      shell: |
        gitlab-runner register \
          --non-interactive \
          --url "{{ gl_local_url }}" \
          --token "{{ runner_auth_token }}" \
          --executor "shell" \
          --description "Runner Shell Auto-provisionné"
      register: runner_reg_local
      when: runner_auth_token is defined
      failed_when: false
      changed_when: "'Runner registered successfully' in runner_reg_local.stderr or 'Registered runner' in runner_reg_local.stderr"

    - name: Démarrage service Runner
      systemd:
        name: gitlab-runner
        state: started
        enabled: yes
      when: runner_auth_token is defined
      failed_when: false

    - name: État final du Runner
      debug:
        msg:
          - "Runner configuré"
          - "Token : {{ runner_auth_token | default('N/A') }}"
      when: runner_auth_token is defined

    - name: Résumé du déploiement
      debug:
        msg:
          - "=== Fin de procédure ==="
          - "Projet disponible : {{ gl_local_url }}/{{ repo_path }}"
          - "Pipeline ID : {{ pipeline_trigger.json.id if pipeline_trigger is defined and pipeline_trigger.status == 201 else 'N/A' }}"
          - "Vérifiez : {{ gl_local_url }}/{{ repo_path }}/-/pipelines"
