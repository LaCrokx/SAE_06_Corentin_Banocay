---
- name: Déploiement de GitLab CE et GitLab Runner (Installation Barebone)
  hosts: gitlab
  become: yes
  vars:
    gitlab_external_url: "http://gitlab.local"
    gitlab_edition: "gitlab-ce"
  
  tasks:
    # Installation des prérequis GitLab CE
    - name: Installation des dépendances GitLab
      apt:
        name:
          - curl
          - openssh-server
          - ca-certificates
          - tzdata
          - perl
          - postfix
        state: present
        update_cache: yes

    - name: Configuration de Postfix pour la livraison locale
      debconf:
        name: postfix
        question: "{{ item.question }}"
        value: "{{ item.value }}"
        vtype: "{{ item.vtype }}"
      loop:
        - { question: 'postfix/main_mailer_type', value: 'Internet Site', vtype: 'select' }
        - { question: 'postfix/mailname', value: 'gitlab.local', vtype: 'string' }
      notify: restart postfix

    # Ajout du dépôt GitLab
    - name: Ajout du script du dépôt GitLab
      get_url:
        url: https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.deb.sh
        dest: /tmp/gitlab_install.sh
        mode: '0755'

    - name: Exécution du script d'installation du dépôt GitLab
      command: bash /tmp/gitlab_install.sh
      args:
        creates: /etc/apt/sources.list.d/gitlab_gitlab-ce.list

    # Installation de GitLab CE
    - name: Installation du paquet GitLab CE
      apt:
        name: gitlab-ce
        state: present
        update_cache: yes
      environment:
        EXTERNAL_URL: "{{ gitlab_external_url }}"

    - name: Configuration de l'URL externe de GitLab
      lineinfile:
        path: /etc/gitlab/gitlab.rb
        regexp: '^external_url'
        line: "external_url '{{ gitlab_external_url }}'"
        create: yes

    - name: Activation du Registre de Conteneurs GitLab
      blockinfile:
        path: /etc/gitlab/gitlab.rb
        block: |
          # Activation du Container Registry
          registry_external_url 'http://gitlab.local:5005'
          gitlab_rails['registry_enabled'] = true
        marker: "# {mark} BLOC GÉRÉ PAR ANSIBLE - REGISTRY"

    - name: Reconfiguration de GitLab
      command: gitlab-ctl reconfigure
      register: gitlab_reconfigure
      changed_when: "'gitlab Reconfigured!' in gitlab_reconfigure.stdout"

    - name: Attente du démarrage complet de Puma (serveur web)
      shell: gitlab-ctl status puma | grep '^run:'
      register: puma_status
      until: puma_status.rc == 0
      retries: 60
      delay: 10
      changed_when: false

    - name: Attente de la disponibilité de l'interface web GitLab
      uri:
        url: "http://127.0.0.1/"
        status_code: 200,302
        timeout: 10
        follow_redirects: none
      register: gitlab_web
      until: gitlab_web.status in [200, 302]
      retries: 30
      delay: 10

    - name: Vérification du endpoint readiness de GitLab
      uri:
        url: "http://127.0.0.1/-/readiness"
        status_code: 200
        timeout: 10
      register: gitlab_ready
      until: gitlab_ready.status == 200
      retries: 20
      delay: 5
      failed_when: false

    - name: Affichage du statut de GitLab
      command: gitlab-ctl status
      register: gitlab_status
      changed_when: false

    - name: Affichage du statut de GitLab (debug)
      debug:
        var: gitlab_status.stdout_lines

    - name: Vérification de l'existence du fichier de mot de passe root initial
      stat:
        path: /etc/gitlab/initial_root_password
      register: password_file

    - name: Récupération du mot de passe root initial de GitLab
      shell: grep 'Password:' /etc/gitlab/initial_root_password | awk '{print $2}'
      register: gitlab_root_password
      when: password_file.stat.exists
      changed_when: false

    - name: Sauvegarde du mot de passe root dans un fichier
      copy:
        content: |
          Identifiants Root GitLab :
          Utilisateur : root
          Mot de passe : {{ gitlab_root_password.stdout }}
          URL : {{ gitlab_external_url }}
          
          Type d'installation : Barebone (Paquet Natif)
          Config : /etc/gitlab/gitlab.rb
          
          Commandes utiles :
          - Vérifier le statut : gitlab-ctl status
          - Reconfigurer : gitlab-ctl reconfigure
          - Redémarrer : gitlab-ctl restart
          - Logs : gitlab-ctl tail
        dest: /root/gitlab_credentials.txt
        mode: '0600'
      when: password_file.stat.exists

    - name: Affichage du mot de passe root GitLab
      debug:
        msg: "Mot de passe root GitLab : {{ gitlab_root_password.stdout }}"
      when: password_file.stat.exists

    # Installation de GitLab Runner (Barebone)
    - name: Téléchargement du script du dépôt GitLab Runner
      get_url:
        url: https://packages.gitlab.com/install/repositories/runner/gitlab-runner/script.deb.sh
        dest: /tmp/gitlab_runner_install.sh
        mode: '0755'

    - name: Exécution du script d'installation du dépôt GitLab Runner
      command: bash /tmp/gitlab_runner_install.sh
      args:
        creates: /etc/apt/sources.list.d/runner_gitlab-runner.list

    - name: Installation du paquet GitLab Runner
      apt:
        name: gitlab-runner
        state: present
        update_cache: yes

    - name: Assurance que le service GitLab Runner est démarré
      service:
        name: gitlab-runner
        state: started
        enabled: yes

    - name: Installation de Docker pour l'exécuteur GitLab Runner
      apt:
        name:
          - docker.io
        state: present
      when: false  # Ignorer si déjà installé

    - name: Ajout de l'utilisateur gitlab-runner au groupe docker
      user:
        name: gitlab-runner
        groups: docker
        append: yes

    - name: Création du script d'enregistrement du runner
      copy:
        dest: /tmp/register_runner.sh
        content: |
          #!/bin/bash
          # Script d'enregistrement GitLab Runner
          
          # Vérifier si le runner est déjà enregistré
          if gitlab-runner list 2>&1 | grep -q "shell-runner"; then
            echo "Runner déjà enregistré"
            exit 0
          fi
          
          # Récupérer le token d'enregistrement depuis l'interface GitLab :
          # Paramètres > CI/CD > Runners > Nouveau runner d'instance
          
          # Remplacez TOKEN par votre token d'enregistrement réel
          TOKEN="VOTRE_TOKEN_ENREGISTREMENT_ICI"
          
          # Enregistrer le runner avec l'exécuteur shell
          gitlab-runner register \
            --non-interactive \
            --url "{{ gitlab_external_url }}" \
            --registration-token "$TOKEN" \
            --executor "shell" \
            --description "shell-runner" \
            --tag-list "shell,python,docker"
          
          echo "Runner enregistré avec succès !"
          echo "Vérifiez le statut avec : gitlab-runner list"
        mode: '0755'

    - name: Affichage du résumé de l'installation GitLab
      debug:
        msg:
          - "=========================================="
          - "Installation de GitLab CE terminée (Barebone) !"
          - "=========================================="
          - "URL GitLab : {{ gitlab_external_url }}"
          - "Utilisateur : root"
          - "Mot de passe : {{ gitlab_root_password.stdout | default('Vérifiez /etc/gitlab/initial_root_password') }}"
          - ""
          - "GitLab Runner installé (Barebone)"
          - "Exécuteur : shell"
          - "Script d'enregistrement : /tmp/register_runner.sh"
          - ""
          - "Prochaines étapes :"
          - "1. Accédez à GitLab sur {{ gitlab_external_url }}"
          - "2. Allez dans Paramètres > CI/CD > Runners > Nouveau runner d'instance"
          - "3. Copiez le token d'enregistrement"
          - "4. Éditez /tmp/register_runner.sh et remplacez VOTRE_TOKEN_ENREGISTREMENT_ICI"
          - "5. Lancez : /tmp/register_runner.sh"
          - ""
          - "Commandes utiles :"
          - "- gitlab-ctl status"
          - "- gitlab-ctl reconfigure"
          - "- gitlab-ctl restart"
          - "- gitlab-runner list"
          - "=========================================="

  handlers:
    - name: restart postfix
      service:
        name: postfix
        state: restarted
