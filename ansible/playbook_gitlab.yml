---
- name: Deploy GitLab CE and GitLab Runner (Barebone Installation)
  hosts: gitlab
  become: yes
  vars:
    gitlab_external_url: "http://gitlab.local"
    gitlab_edition: "gitlab-ce"
  
  tasks:
    # Install GitLab CE Prerequisites
    - name: Install GitLab dependencies
      apt:
        name:
          - curl
          - openssh-server
          - ca-certificates
          - tzdata
          - perl
          - postfix
        state: present
        update_cache: yes

    - name: Configure Postfix for local delivery
      debconf:
        name: postfix
        question: "{{ item.question }}"
        value: "{{ item.value }}"
        vtype: "{{ item.vtype }}"
      loop:
        - { question: 'postfix/main_mailer_type', value: 'Internet Site', vtype: 'select' }
        - { question: 'postfix/mailname', value: 'gitlab.local', vtype: 'string' }
      notify: restart postfix

    # Add GitLab Repository
    - name: Add GitLab repository script
      get_url:
        url: https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.deb.sh
        dest: /tmp/gitlab_install.sh
        mode: '0755'

    - name: Run GitLab repository setup script
      command: bash /tmp/gitlab_install.sh
      args:
        creates: /etc/apt/sources.list.d/gitlab_gitlab-ce.list

    # Install GitLab CE
    - name: Install GitLab CE package
      apt:
        name: gitlab-ce
        state: present
        update_cache: yes
      environment:
        EXTERNAL_URL: "{{ gitlab_external_url }}"

    - name: Configure GitLab external URL
      lineinfile:
        path: /etc/gitlab/gitlab.rb
        regexp: '^external_url'
        line: "external_url '{{ gitlab_external_url }}'"
        create: yes

    - name: Enable GitLab Container Registry
      blockinfile:
        path: /etc/gitlab/gitlab.rb
        block: |
          # Enable Container Registry
          registry_external_url 'http://gitlab.local:5050'
          gitlab_rails['registry_enabled'] = true
        marker: "# {mark} ANSIBLE MANAGED BLOCK - REGISTRY"

    - name: Reconfigure GitLab
      command: gitlab-ctl reconfigure
      register: gitlab_reconfigure
      changed_when: "'gitlab Reconfigured!' in gitlab_reconfigure.stdout"

    - name: Wait for Puma (web server) to be fully started
      shell: gitlab-ctl status puma | grep '^run:'
      register: puma_status
      until: puma_status.rc == 0
      retries: 60
      delay: 10
      changed_when: false

    - name: Wait for GitLab web interface to be ready
      uri:
        url: "http://127.0.0.1/"
        status_code: 200,302
        timeout: 10
        follow_redirects: none
      register: gitlab_web
      until: gitlab_web.status in [200, 302]
      retries: 30
      delay: 10

    - name: Check GitLab readiness endpoint
      uri:
        url: "http://127.0.0.1/-/readiness"
        status_code: 200
        timeout: 10
      register: gitlab_ready
      until: gitlab_ready.status == 200
      retries: 20
      delay: 5
      failed_when: false

    - name: Display GitLab status
      command: gitlab-ctl status
      register: gitlab_status
      changed_when: false

    - name: Show GitLab status
      debug:
        var: gitlab_status.stdout_lines

    - name: Check if initial root password file exists
      stat:
        path: /etc/gitlab/initial_root_password
      register: password_file

    - name: Get GitLab initial root password
      shell: grep 'Password:' /etc/gitlab/initial_root_password | awk '{print $2}'
      register: gitlab_root_password
      when: password_file.stat.exists
      changed_when: false

    - name: Save root password to file
      copy:
        content: |
          GitLab Root Credentials:
          Username: root
          Password: {{ gitlab_root_password.stdout }}
          URL: {{ gitlab_external_url }}
          
          Installation Type: Barebone (Native Package)
          Config: /etc/gitlab/gitlab.rb
          
          Commands:
          - Check status: gitlab-ctl status
          - Reconfigure: gitlab-ctl reconfigure
          - Restart: gitlab-ctl restart
          - Logs: gitlab-ctl tail
        dest: /root/gitlab_credentials.txt
        mode: '0600'
      when: password_file.stat.exists

    - name: Display GitLab root password
      debug:
        msg: "GitLab root password: {{ gitlab_root_password.stdout }}"
      when: password_file.stat.exists

    # Install GitLab Runner (Barebone)
    - name: Download GitLab Runner repository script
      get_url:
        url: https://packages.gitlab.com/install/repositories/runner/gitlab-runner/script.deb.sh
        dest: /tmp/gitlab_runner_install.sh
        mode: '0755'

    - name: Run GitLab Runner repository setup script
      command: bash /tmp/gitlab_runner_install.sh
      args:
        creates: /etc/apt/sources.list.d/runner_gitlab-runner.list

    - name: Install GitLab Runner package
      apt:
        name: gitlab-runner
        state: present
        update_cache: yes

    - name: Ensure GitLab Runner service is running
      service:
        name: gitlab-runner
        state: started
        enabled: yes

    - name: Ensure Docker service is running (already installed as Docker CE)
      service:
        name: docker
        state: started
        enabled: yes

    - name: Add gitlab-runner user to docker group
      user:
        name: gitlab-runner
        groups: docker
        append: yes

    # Install kubectl for GitLab Runner
    - name: Install kubectl
      get_url:
        url: https://dl.k8s.io/release/v1.28.2/bin/linux/amd64/kubectl
        dest: /usr/local/bin/kubectl
        mode: '0755'

    - name: Ensure .kube directory exists for gitlab-runner
      file:
        path: /home/gitlab-runner/.kube
        state: directory
        owner: gitlab-runner
        group: gitlab-runner
        mode: '0700'

    - name: Fetch kubeconfig from k8s-master
      fetch:
        src: /etc/kubernetes/admin.conf
        dest: /tmp/admin.conf
        flat: yes
      delegate_to: k8s-master

    - name: Copy kubeconfig to gitlab-runner home
      copy:
        src: /tmp/admin.conf
        dest: /home/gitlab-runner/.kube/config
        owner: gitlab-runner
        group: gitlab-runner
        mode: '0600'

    - name: Auto-register GitLab Runner via gitlab-rails
      shell: |
        #!/bin/bash
        # Get runner registration token from PostgreSQL
        TOKEN=$(sudo -u gitlab-psql /opt/gitlab/embedded/bin/psql -h /var/opt/gitlab/postgresql -d gitlabhq_production -t -c "SELECT runners_registration_token FROM application_settings WHERE runners_registration_token IS NOT NULL ORDER BY id DESC LIMIT 1;" 2>/dev/null | tr -d ' \t\n')
        
        if [ -z "$TOKEN" ]; then
          # Fallback: use gitlab-rails runner
          TOKEN=$(timeout 60 gitlab-rails runner "puts ApplicationSetting.current.runners_registration_token" 2>/dev/null | tail -1 | tr -d ' \t\n')
        fi
        
        if [ -z "$TOKEN" ]; then
          echo "ERROR: Could not retrieve runner registration token"
          exit 1
        fi
        
        echo "Token retrieved: ${TOKEN:0:20}..."
        
        # Register Shell runner if not already registered
        if ! gitlab-runner list 2>/dev/null | grep -q 'shell-runner'; then
          gitlab-runner register \
            --non-interactive \
            --url '{{ gitlab_external_url }}' \
            --registration-token "$TOKEN" \
            --executor 'shell' \
            --description 'shell-runner' \
            --tag-list 'shell,docker,deployment' \
            --run-untagged
          echo "Shell runner registered"
        else
          echo "Shell runner already exists"
        fi
        
        # Restart the service
        systemctl restart gitlab-runner
        
        # Show registered runners
        echo "=== Registered Runners ==="
        gitlab-runner list 2>/dev/null
      args:
        executable: /bin/bash
      register: runner_registration
      failed_when: false
      changed_when: "'registered' in runner_registration.stdout"

    - name: Display runner registration output
      debug:
        var: runner_registration.stdout_lines
      when: runner_registration.stdout_lines is defined

    - name: Display GitLab setup summary
      debug:
        msg:
          - "=========================================="
          - "GitLab CE Installation Complete!"
          - "=========================================="
          - "GitLab URL: {{ gitlab_external_url }}"
          - "Username: root"
          - "Password: {{ gitlab_root_password.stdout | default('Check /etc/gitlab/initial_root_password') }}"
          - ""
          - "GitLab Runner: auto-registered (shell executor)"
          - "Tags: shell, docker, deployment"
          - ""
          - "Useful commands:"
          - "- gitlab-ctl status"
          - "- gitlab-ctl reconfigure"
          - "- gitlab-runner list"
          - "=========================================="

  handlers:
    - name: restart postfix
      service:
        name: postfix
        state: restarted
