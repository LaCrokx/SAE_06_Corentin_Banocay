---
- name: Deploy GitLab CE and GitLab Runner (Barebone Installation)
  hosts: gitlab
  become: yes
  vars:
    gitlab_external_url: "http://gitlab.local"
    gitlab_edition: "gitlab-ce"
  
  tasks:
    # Install GitLab CE Prerequisites
    - name: Install GitLab dependencies
      apt:
        name:
          - curl
          - openssh-server
          - ca-certificates
          - tzdata
          - perl
          - postfix
        state: present
        update_cache: yes

    - name: Configure Postfix for local delivery
      debconf:
        name: postfix
        question: "{{ item.question }}"
        value: "{{ item.value }}"
        vtype: "{{ item.vtype }}"
      loop:
        - { question: 'postfix/main_mailer_type', value: 'Internet Site', vtype: 'select' }
        - { question: 'postfix/mailname', value: 'gitlab.local', vtype: 'string' }
      notify: restart postfix

    # Add GitLab Repository
    - name: Add GitLab repository script
      get_url:
        url: https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.deb.sh
        dest: /tmp/gitlab_install.sh
        mode: '0755'

    - name: Run GitLab repository setup script
      command: bash /tmp/gitlab_install.sh
      args:
        creates: /etc/apt/sources.list.d/gitlab_gitlab-ce.list

    # Install GitLab CE
    - name: Install GitLab CE package
      apt:
        name: gitlab-ce
        state: present
        update_cache: yes
      environment:
        EXTERNAL_URL: "{{ gitlab_external_url }}"

    - name: Configure GitLab external URL
      lineinfile:
        path: /etc/gitlab/gitlab.rb
        regexp: '^external_url'
        line: "external_url '{{ gitlab_external_url }}'"
        create: yes

    - name: Enable GitLab Container Registry
      blockinfile:
        path: /etc/gitlab/gitlab.rb
        block: |
          # Enable Container Registry
          registry_external_url 'http://gitlab.local:5005'
          gitlab_rails['registry_enabled'] = true
        marker: "# {mark} ANSIBLE MANAGED BLOCK - REGISTRY"

    - name: Reconfigure GitLab
      command: gitlab-ctl reconfigure
      register: gitlab_reconfigure
      changed_when: "'gitlab Reconfigured!' in gitlab_reconfigure.stdout"

    - name: Wait for Puma (web server) to be fully started
      shell: gitlab-ctl status puma | grep '^run:'
      register: puma_status
      until: puma_status.rc == 0
      retries: 60
      delay: 10
      changed_when: false

    - name: Wait for GitLab web interface to be ready
      uri:
        url: "http://127.0.0.1/"
        status_code: 200,302
        timeout: 10
        follow_redirects: none
      register: gitlab_web
      until: gitlab_web.status in [200, 302]
      retries: 30
      delay: 10

    - name: Check GitLab readiness endpoint
      uri:
        url: "http://127.0.0.1/-/readiness"
        status_code: 200
        timeout: 10
      register: gitlab_ready
      until: gitlab_ready.status == 200
      retries: 20
      delay: 5
      failed_when: false

    - name: Display GitLab status
      command: gitlab-ctl status
      register: gitlab_status
      changed_when: false

    - name: Show GitLab status
      debug:
        var: gitlab_status.stdout_lines

    - name: Check if initial root password file exists
      stat:
        path: /etc/gitlab/initial_root_password
      register: password_file

    - name: Get GitLab initial root password
      shell: grep 'Password:' /etc/gitlab/initial_root_password | awk '{print $2}'
      register: gitlab_root_password
      when: password_file.stat.exists
      changed_when: false

    - name: Save root password to file
      copy:
        content: |
          GitLab Root Credentials:
          Username: root
          Password: {{ gitlab_root_password.stdout }}
          URL: {{ gitlab_external_url }}
          
          Installation Type: Barebone (Native Package)
          Config: /etc/gitlab/gitlab.rb
          
          Commands:
          - Check status: gitlab-ctl status
          - Reconfigure: gitlab-ctl reconfigure
          - Restart: gitlab-ctl restart
          - Logs: gitlab-ctl tail
        dest: /root/gitlab_credentials.txt
        mode: '0600'
      when: password_file.stat.exists

    - name: Display GitLab root password
      debug:
        msg: "GitLab root password: {{ gitlab_root_password.stdout }}"
      when: password_file.stat.exists

    # Install GitLab Runner (Barebone)
    - name: Download GitLab Runner repository script
      get_url:
        url: https://packages.gitlab.com/install/repositories/runner/gitlab-runner/script.deb.sh
        dest: /tmp/gitlab_runner_install.sh
        mode: '0755'

    - name: Run GitLab Runner repository setup script
      command: bash /tmp/gitlab_runner_install.sh
      args:
        creates: /etc/apt/sources.list.d/runner_gitlab-runner.list

    - name: Install GitLab Runner package
      apt:
        name: gitlab-runner
        state: present
        update_cache: yes

    - name: Ensure GitLab Runner service is running
      service:
        name: gitlab-runner
        state: started
        enabled: yes

    - name: Install Docker for GitLab Runner executor
      apt:
        name:
          - docker.io
        state: present
      when: false  # Skip if already installed

    - name: Add gitlab-runner user to docker group
      user:
        name: gitlab-runner
        groups: docker
        append: yes

    - name: Create runner registration script
      copy:
        dest: /tmp/register_runner.sh
        content: |
          #!/bin/bash
          # GitLab Runner Registration Script
          
          # Check if runner is already registered
          if gitlab-runner list 2>&1 | grep -q "shell-runner"; then
            echo "Runner already registered"
            exit 0
          fi
          
          # Get registration token from GitLab UI:
          # Settings > CI/CD > Runners > New instance runner
          
          # Replace TOKEN with your actual registration token
          TOKEN="YOUR_REGISTRATION_TOKEN_HERE"
          
          # Register runner with shell executor
          gitlab-runner register \
            --non-interactive \
            --url "{{ gitlab_external_url }}" \
            --registration-token "$TOKEN" \
            --executor "shell" \
            --description "shell-runner" \
            --tag-list "shell,python,docker"
          
          echo "Runner registered successfully!"
          echo "Check status with: gitlab-runner list"
        mode: '0755'

    - name: Display GitLab setup summary
      debug:
        msg:
          - "=========================================="
          - "GitLab CE Installation Complete (Barebone)!"
          - "=========================================="
          - "GitLab URL: {{ gitlab_external_url }}"
          - "Username: root"
          - "Password: {{ gitlab_root_password.stdout | default('Check /etc/gitlab/initial_root_password') }}"
          - ""
          - "GitLab Runner installed (Barebone)"
          - "Executor: shell"
          - "Registration script: /tmp/register_runner.sh"
          - ""
          - "Next steps:"
          - "1. Access GitLab at {{ gitlab_external_url }}"
          - "2. Go to Settings > CI/CD > Runners > New instance runner"
          - "3. Copy the registration token"
          - "4. Edit /tmp/register_runner.sh and replace YOUR_REGISTRATION_TOKEN_HERE"
          - "5. Run: /tmp/register_runner.sh"
          - ""
          - "Useful commands:"
          - "- gitlab-ctl status"
          - "- gitlab-ctl reconfigure"
          - "- gitlab-ctl restart"
          - "- gitlab-runner list"
          - "=========================================="

  handlers:
    - name: restart postfix
      service:
        name: postfix
        state: restarted
